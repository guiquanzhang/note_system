# 🔍 诊断回收站问题

## 问题：删除笔记后回收站为空

---

## 🧪 诊断步骤

### 步骤 1：检查数据库
```sql
-- 查看所有笔记的删除状态
USE cloudnote;
SELECT note_id, title, deleted, deleted_at 
FROM note 
ORDER BY note_id DESC 
LIMIT 10;

-- 查看已删除的笔记
SELECT note_id, title, deleted, deleted_at 
FROM note 
WHERE deleted = 1;
```

**预期结果**：
- 删除的笔记应该有 `deleted = 1`
- `deleted_at` 应该有时间戳

---

### 步骤 2：检查后端是否重启
```
1. 查看 IDEA 控制台
2. 确认看到 "Started CloudNoteApplication"
3. 查看启动时间是否是最近的
```

**如果没有重启**：
```
1. 停止后端服务
2. 点击 Build → Rebuild Project
3. 重新运行 CloudNoteApplication
```

---

### 步骤 3：检查后端接口映射
在后端控制台搜索以下日志：
```
Mapped "{[/note/trash],methods=[GET]}"
Mapped "{[/note/{noteId}/restore],methods=[PUT]}"
Mapped "{[/note/{noteId}/permanent],methods=[DELETE]}"
Mapped "{[/note/trash/empty],methods=[DELETE]}"
```

**如果没有这些日志**：
- 说明后端代码没有生效
- 需要重新编译和启动

---

### 步骤 4：测试删除接口
```
1. 在笔记列表中删除一条笔记
2. 打开浏览器控制台（F12）
3. 查看 Network 标签
4. 找到 DELETE /api/note/{id} 请求
5. 查看响应状态码和内容
```

**预期结果**：
- 状态码：200
- 响应：`{"code":200,"message":"操作成功","data":null}`

---

### 步骤 5：检查数据库更新
删除笔记后，立即查询数据库：
```sql
USE cloudnote;
SELECT note_id, title, deleted, deleted_at 
FROM note 
WHERE note_id = {刚才删除的笔记ID};
```

**预期结果**：
- `deleted` 应该是 1
- `deleted_at` 应该有当前时间

**如果 deleted 还是 0**：
- 说明删除接口没有正确更新数据库
- 检查后端代码是否生效

---

### 步骤 6：测试回收站接口
在浏览器控制台执行：
```javascript
// 获取 token
const token = localStorage.getItem('token')

// 调用回收站接口
fetch('http://localhost:8080/api/note/trash?pageNum=1&pageSize=10', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(data => console.log(data))
```

**预期结果**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "records": [
      {
        "noteId": 16,
        "title": "...",
        "deleted": 1,
        "deletedAt": "2024-12-20T13:59:42"
      }
    ],
    "total": 1
  }
}
```

**如果返回 404**：
- 后端接口没有注册
- 需要重启后端

**如果返回空数组**：
- 数据库中没有 deleted = 1 的数据
- 删除功能没有正常工作

---

### 步骤 7：检查前端 API 调用
打开浏览器控制台，访问回收站页面：
```
1. 访问 http://localhost:5173/notes/trash
2. 打开 F12 控制台
3. 查看 Network 标签
4. 找到 GET /api/note/trash 请求
5. 查看请求和响应
```

**检查项**：
- 请求 URL 是否正确
- 请求头是否包含 Authorization
- 响应状态码
- 响应数据

---

## 🔧 快速修复方案

### 方案 1：手动创建测试数据
```sql
USE cloudnote;

-- 将一条笔记标记为已删除
UPDATE note 
SET deleted = 1, deleted_at = NOW() 
WHERE note_id = (SELECT note_id FROM (SELECT note_id FROM note WHERE deleted = 0 LIMIT 1) AS temp);

-- 验证
SELECT note_id, title, deleted, deleted_at 
FROM note 
WHERE deleted = 1;
```

然后刷新回收站页面，应该能看到这条笔记。

---

### 方案 2：检查 deleted 字段类型
```sql
USE cloudnote;
DESC note;
```

**检查 deleted 字段**：
- 类型应该是 `tinyint`
- 默认值应该是 `0`

**如果类型不对**：
```sql
ALTER TABLE note 
MODIFY COLUMN deleted TINYINT DEFAULT 0;
```

---

### 方案 3：重新执行数据库更新
```sql
USE cloudnote;

-- 确保 deleted 字段存在且类型正确
ALTER TABLE note 
MODIFY COLUMN deleted TINYINT DEFAULT 0 COMMENT '是否删除：0=正常，1=已删除';

-- 确保 deleted_at 字段存在
ALTER TABLE note 
MODIFY COLUMN deleted_at TIMESTAMP NULL COMMENT '删除时间';

-- 确保索引存在
ALTER TABLE note 
ADD INDEX IF NOT EXISTS idx_deleted (deleted);

-- 将所有 NULL 的 deleted 设置为 0
UPDATE note SET deleted = 0 WHERE deleted IS NULL;
```

---

## 🐛 常见问题

### 问题 1：后端没有重启
**症状**：
- 删除笔记后 deleted 还是 0
- 回收站接口返回 404

**解决**：
```
1. 停止后端服务
2. Build → Rebuild Project
3. 重新运行
```

---

### 问题 2：前端缓存
**症状**：
- 后端接口正常
- 前端页面显示不正确

**解决**：
```
1. 清除浏览器缓存（Ctrl + Shift + Delete）
2. 硬刷新（Ctrl + F5）
3. 重启前端服务
```

---

### 问题 3：数据库字段问题
**症状**：
- 删除后 deleted 字段没有更新

**解决**：
```sql
-- 检查字段
DESC note;

-- 如果字段不存在或类型不对，重新创建
ALTER TABLE note 
ADD COLUMN deleted TINYINT DEFAULT 0 AFTER tags;

ALTER TABLE note 
ADD COLUMN deleted_at TIMESTAMP NULL AFTER deleted;
```

---

### 问题 4：MyBatis Plus 缓存
**症状**：
- 数据库已更新
- 查询结果还是旧数据

**解决**：
```
重启后端服务
```

---

## ✅ 验证清单

完成以下检查：

- [ ] 数据库中有 deleted = 1 的笔记
- [ ] 后端已重启（查看启动时间）
- [ ] 后端控制台有回收站接口映射日志
- [ ] 删除笔记后 deleted 字段变为 1
- [ ] 回收站接口返回正确数据
- [ ] 前端页面能显示已删除笔记

---

## 🚀 快速测试命令

### 创建测试数据
```sql
USE cloudnote;

-- 创建一条测试笔记
INSERT INTO note (title, content, user_id, deleted, deleted_at) 
VALUES ('测试已删除笔记', '这是一条测试笔记', 1, 1, NOW());

-- 查看
SELECT * FROM note WHERE deleted = 1;
```

### 测试回收站接口（使用 curl）
```bash
# 先登录获取 token
curl -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'

# 使用返回的 token 访问回收站
curl -X GET "http://localhost:8080/api/note/trash?pageNum=1&pageSize=10" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

---

## 📞 需要帮助？

如果以上步骤都无法解决问题，请提供：
1. 后端控制台日志
2. 浏览器控制台错误信息
3. 数据库查询结果
4. Network 请求详情

---

**文档版本**: v1.0.0  
**创建日期**: 2024-12-20
