# 图片显示修复说明

## 问题原因

图片上传成功，数据库保存的是相对路径（如 `/uploads/notes/xxx.jpg`），但前端显示时没有拼接完整的 API 地址，导致浏览器无法加载图片。

## 解决方案

创建了 `content.js` 工具函数，自动处理笔记内容中的图片 URL：

### 1. 显示笔记时（Detail.vue）
- 从数据库读取：`/uploads/notes/xxx.jpg`
- 自动转换为：`http://localhost:8080/api/uploads/notes/xxx.jpg`
- 浏览器可以正常加载图片

### 2. 编辑笔记时（Edit.vue）
- **加载时**：相对路径 → 完整 URL（编辑器显示）
- **保存时**：完整 URL → 相对路径（数据库存储）

## 测试步骤

### 测试 1：新建笔记插入图片

1. 刷新前端页面（Ctrl+F5）
2. 新建笔记
3. 插入图片
4. 保存
5. 查看笔记详情 → **图片应该正常显示**

### 测试 2：编辑已有笔记

1. 打开一个包含图片的笔记
2. 点击"编辑"
3. 编辑器中 → **图片应该正常显示**
4. 可以继续添加新图片
5. 保存后查看 → **所有图片都应该正常显示**

### 测试 3：查看数据库

```sql
SELECT 
    note_id, 
    title, 
    SUBSTRING(content, 1, 300) as content_preview
FROM note 
WHERE user_id = 7 
  AND content LIKE '%<img%'
ORDER BY created_at DESC 
LIMIT 1;
```

**预期结果**：
- content 中应该只包含相对路径：`<img src="/uploads/notes/xxx.jpg">`
- 不应该包含完整 URL：`<img src="http://localhost:8080/api/uploads/notes/xxx.jpg">`

## 技术实现

### content.js 工具函数

```javascript
// 显示时：相对路径 → 完整 URL
export const processNoteContent = (content) => {
  return content.replace(
    /<img([^>]*?)src=["'](?!http|data:)([^"']+)["']/gi,
    (match, attrs, src) => {
      const normalizedSrc = src.startsWith('/') ? src : '/' + src
      return `<img${attrs}src="${fullApiUrl}${normalizedSrc}"`
    }
  )
}
```

### Edit.vue 保存逻辑

```javascript
// 保存时：完整 URL → 相对路径
const normalizeContent = (content) => {
  return content.replace(
    new RegExp(`${fullApiUrl}(/uploads/[^"'\\s]+)`, 'gi'),
    '$1'
  )
}
```

## 优势

1. **数据库存储优化**：只存相对路径，节省空间
2. **灵活性**：如果 API 地址改变，不需要修改数据库
3. **兼容性**：支持 Base64 图片（旧数据）和 URL 图片（新数据）
4. **自动处理**：前端自动转换，后端无需改动

## 验证清单

- ✅ 新建笔记插入图片 → 保存成功
- ✅ 笔记详情页 → 图片正常显示
- ✅ 编辑笔记 → 图片正常显示
- ✅ 数据库 → 只存相对路径
- ✅ 浏览器 → 加载完整 URL
- ✅ 旧笔记（Base64）→ 仍然正常显示
