# 回收站恢复功能修复说明

## 问题原因

恢复笔记时报错 "笔记不存在或无权限"，原因是：

1. MyBatis Plus 配置了逻辑删除（`logic-delete-field: deleted`）
2. `selectById()` 方法会自动过滤 `deleted=1` 的记录
3. 回收站中的笔记 `deleted=1`，所以 `selectById()` 查不到
4. 导致权限验证失败

## 解决方案

添加自定义 SQL 方法 `selectByIdIncludeDeleted()`，绕过 MyBatis Plus 的逻辑删除过滤。

### 修改内容

**1. NoteMapper.java**
```java
/**
 * 根据 ID 查询笔记（包括已删除的）
 */
@Select("SELECT * FROM note WHERE note_id = #{noteId}")
Note selectByIdIncludeDeleted(@Param("noteId") Integer noteId);
```

**2. NoteServiceImpl.java**
```java
@Override
public void restoreNote(Integer noteId, Integer userId) {
    // 使用自定义 SQL 查询（包括已删除的笔记）
    Note note = noteMapper.selectByIdIncludeDeleted(noteId);
    if (note == null || !note.getUserId().equals(userId)) {
        throw new RuntimeException("笔记不存在或无权限");
    }
    
    // 使用自定义 SQL 恢复笔记
    noteMapper.restore(noteId);
}

@Override
public void permanentlyDeleteNote(Integer noteId, Integer userId) {
    // 使用自定义 SQL 查询（包括已删除的笔记）
    Note note = noteMapper.selectByIdIncludeDeleted(noteId);
    if (note == null || !note.getUserId().equals(userId)) {
        throw new RuntimeException("笔记不存在或无权限");
    }
    
    // 使用自定义 SQL 永久删除
    noteMapper.permanentDelete(noteId);
}
```

## 测试步骤

### 1. 重启后端
停止并重新启动 Spring Boot 应用

### 2. 测试恢复笔记
1. 打开回收站页面
2. 点击"恢复"按钮
3. 应该显示"恢复成功"
4. 笔记应该从回收站消失
5. 在笔记列表中应该能看到恢复的笔记

### 3. 测试永久删除
1. 删除一个笔记到回收站
2. 在回收站中点击"永久删除"
3. 应该显示"删除成功"
4. 笔记应该从回收站消失
5. 数据库中应该找不到这条记录

### 4. 测试清空回收站
1. 删除几个笔记到回收站
2. 点击"清空回收站"
3. 应该显示"清空成功"
4. 回收站应该为空

## 验证

### 验证恢复功能
```sql
-- 1. 删除一个笔记
UPDATE note SET deleted = 1, deleted_at = NOW() WHERE note_id = 22;

-- 2. 查看回收站
SELECT note_id, title, deleted, deleted_at 
FROM note 
WHERE user_id = 7 AND deleted = 1;

-- 3. 在前端点击"恢复"

-- 4. 验证笔记已恢复
SELECT note_id, title, deleted, deleted_at 
FROM note 
WHERE note_id = 22;
-- 预期：deleted = 0, deleted_at = NULL
```

### 验证永久删除功能
```sql
-- 1. 删除一个笔记
UPDATE note SET deleted = 1, deleted_at = NOW() WHERE note_id = 23;

-- 2. 在前端点击"永久删除"

-- 3. 验证笔记已被物理删除
SELECT * FROM note WHERE note_id = 23;
-- 预期：查询结果为空
```

## 关键点

1. **逻辑删除的限制**：MyBatis Plus 的 `selectById()` 会自动过滤已删除的记录
2. **自定义 SQL**：使用 `@Select` 注解直接查询数据库，绕过逻辑删除过滤
3. **权限验证**：仍然需要验证笔记所属用户，防止越权操作
4. **一致性**：`restoreNote` 和 `permanentlyDeleteNote` 都需要使用自定义查询

## 成功标志

- ✅ 恢复笔记成功，不再报错
- ✅ 笔记从回收站消失
- ✅ 笔记在笔记列表中显示
- ✅ 永久删除成功
- ✅ 清空回收站成功
