# 测试图片上传优化

## 快速测试步骤

### 1. 执行数据库修复
```sql
USE cloudnote;
ALTER TABLE `note` MODIFY COLUMN `content` LONGTEXT COMMENT '笔记内容（支持富文本和图片）';
```

### 2. 重启后端
停止并重新启动 Spring Boot 应用

### 3. 刷新前端
在浏览器中刷新页面（Ctrl+F5 强制刷新）

### 4. 测试图片上传

#### 步骤：
1. 登录系统（用户：11111111）
2. 点击"新建笔记"
3. 输入标题：`图片上传测试`
4. 点击编辑器工具栏的"插入图片"按钮（📷 图标）
5. 选择一张图片（建议 100KB-1MB）
6. 等待上传（会显示"正在上传图片..."）
7. 看到"图片上传成功"提示
8. 图片应该显示在编辑器中
9. 点击"保存"

### 5. 验证结果

#### 方式 1：查看网络请求
打开浏览器开发者工具（F12）→ Network：
- 应该看到 `POST /api/file/upload/note-image` 请求
- 响应应该返回图片 URL，如：`/uploads/notes/xxx.jpg`

#### 方式 2：查看数据库
```sql
SELECT 
    note_id, 
    title, 
    LENGTH(content) as content_length,
    SUBSTRING(content, 1, 200) as content_preview
FROM note 
WHERE user_id = 7 
  AND title = '图片上传测试'
ORDER BY created_at DESC 
LIMIT 1;
```

**预期结果**：
- `content_length` 应该很小（几百字节，而不是几十万字节）
- `content_preview` 应该包含 `<img src="http://localhost:8080/api/uploads/notes/xxx.jpg">`

#### 方式 3：查看文件系统
检查 `uploads/notes/` 目录：
- 应该有新上传的图片文件
- 文件名格式：`xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.jpg`

### 6. 对比测试

#### 测试 A：新方式（URL）
1. 创建笔记，插入 1 张图片
2. 保存后查看数据库 content 字段大小
3. 记录：`content_length_url = _____ 字节`

#### 测试 B：旧方式（Base64）- 仅供对比
如果想看旧方式的效果，可以：
1. 临时注释掉新代码
2. 恢复旧的 Base64 代码
3. 插入同一张图片
4. 记录：`content_length_base64 = _____ 字节`

**预期对比**：
- URL 方式：~500 字节
- Base64 方式：~500,000 字节（1000 倍差距！）

## 常见问题

### Q1: 上传失败，提示"文件上传失败"
**原因**：uploads/notes 目录不存在或无写入权限
**解决**：
```bash
# Windows
mkdir uploads\notes

# 或者让后端自动创建（代码已包含）
```

### Q2: 图片显示不出来
**原因**：静态资源配置问题
**检查**：
1. 访问 `http://localhost:8080/api/uploads/notes/xxx.jpg`（替换为实际文件名）
2. 如果 404，检查 `WebConfig.java` 的静态资源配置

### Q3: 旧笔记的 Base64 图片还能看吗？
**答案**：能！新代码不影响旧数据，Base64 图片仍然可以正常显示

### Q4: 数据库字段改了会影响旧数据吗？
**答案**：不会！TEXT → LONGTEXT 只是扩大容量，不会丢失数据

## 性能验证

### 测试场景：包含 5 张图片的笔记

#### 指标 1：数据库大小
```sql
SELECT 
    SUM(LENGTH(content)) / 1024 / 1024 as total_mb
FROM note 
WHERE user_id = 7;
```

#### 指标 2：加载速度
1. 打开笔记详情页
2. 查看 Network 面板
3. 记录总传输大小和加载时间

**预期改善**：
- 数据库大小：减少 60-70%
- 首次加载：减少 50-60%
- 二次加载：减少 90%+（浏览器缓存）

## 成功标志

✅ 图片上传成功，显示"图片上传成功"
✅ 编辑器中能看到图片
✅ 保存笔记成功
✅ 数据库 content 字段很小（几百字节）
✅ uploads/notes/ 目录有图片文件
✅ 刷新页面后图片仍然显示
