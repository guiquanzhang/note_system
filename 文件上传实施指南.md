# 文件上传实施指南

## 方案说明

将头像从 Base64 存储改为文件存储，图片保存到服务器硬盘，数据库只存储文件路径。

## 优势对比

| 特性 | Base64方案 | 文件存储方案 ✅ |
|------|-----------|----------------|
| 数据库大小 | 大（每个头像约50-100KB） | 小（每个路径约50字节） |
| 查询速度 | 慢 | 快 |
| 传输效率 | 低 | 高 |
| CDN支持 | 不支持 | 支持 |
| 备份管理 | 困难 | 简单 |
| 图片处理 | 困难 | 简单 |

## 实施步骤

### 1. 更新数据库字段

```sql
USE cloudnote;

-- 将 avatar 字段改为 VARCHAR(500)
ALTER TABLE `user` 
MODIFY COLUMN `avatar` VARCHAR(500) COMMENT '用户头像URL';
```

### 2. 创建上传目录

在项目根目录创建：
```bash
mkdir -p uploads/avatars
```

或者让程序自动创建（已在代码中实现）

### 3. 重启后端服务

停止并重新启动 Spring Boot 应用

### 4. 测试上传

1. 登录系统
2. 进入个人信息页面
3. 点击"编辑信息"
4. 选择头像
5. 等待上传完成
6. 点击"保存"

## 文件结构

```
cloudnote/
├── uploads/              # 文件上传目录
│   └── avatars/         # 头像目录
│       ├── abc123.jpg   # 用户头像文件
│       ├── def456.png
│       └── ...
├── src/
│   └── main/
│       ├── java/
│       │   └── com/cloudnote/
│       │       ├── controller/
│       │       │   └── FileController.java  # 文件上传控制器
│       │       └── config/
│       │           └── WebConfig.java       # 静态资源配置
│       └── resources/
│           └── application.yml              # 文件上传配置
└── front_end/
    └── src/
        └── api/
            └── file.js                      # 文件上传API
```

## 配置说明

### application.yml

```yaml
# 文件上传配置
file:
  upload:
    path: uploads  # 相对路径，相对于项目根目录
    # 或使用绝对路径: path: /var/www/uploads
  access:
    url: /uploads  # 访问URL前缀

# Spring文件上传配置
spring:
  servlet:
    multipart:
      max-file-size: 10MB  # 单个文件最大大小
      max-request-size: 10MB  # 请求最大大小
```

### 生产环境配置

```yaml
file:
  upload:
    path: /var/www/cloudnote/uploads  # 绝对路径
  access:
    url: /uploads
```

## API接口

### 上传头像

**接口**: `POST /api/file/upload/avatar`

**请求**:
```
Content-Type: multipart/form-data
Authorization: Bearer {token}

file: (binary)
```

**响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": "/uploads/avatars/abc123.jpg"
}
```

### 删除文件

**接口**: `DELETE /api/file/delete`

**请求**:
```
Authorization: Bearer {token}
?url=/uploads/avatars/abc123.jpg
```

**响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

## 访问方式

### 开发环境
```
http://localhost:8080/uploads/avatars/abc123.jpg
```

### 生产环境
```
https://your-domain.com/uploads/avatars/abc123.jpg
```

## 数据库存储

### 存储格式
```
/uploads/avatars/abc123.jpg
```

### 查询示例
```sql
SELECT user_id, username, avatar 
FROM user 
WHERE avatar IS NOT NULL;
```

### 结果示例
```
user_id | username | avatar
--------|----------|--------------------------------
1       | admin    | /uploads/avatars/abc123.jpg
2       | user1    | /uploads/avatars/def456.png
```

## 前端使用

### 上传头像
```javascript
import { uploadAvatar } from '@/api/file'

const file = event.target.files[0]
const imageUrl = await uploadAvatar(file)
// imageUrl: "/uploads/avatars/abc123.jpg"
```

### 显示头像
```vue
<el-avatar :src="getAvatarUrl(user.avatar)" />

<script>
const getAvatarUrl = (avatar) => {
  if (!avatar) return ''
  if (avatar.startsWith('http')) return avatar
  return `http://localhost:8080${avatar}`
}
</script>
```

## 安全性

### 1. 文件类型验证
```java
// 只允许图片类型
if (!contentType.startsWith("image/")) {
    return Result.error("只能上传图片文件");
}
```

### 2. 文件大小限制
```java
// 限制5MB
if (file.getSize() > 5 * 1024 * 1024) {
    return Result.error("文件大小不能超过 5MB");
}
```

### 3. 文件名随机化
```java
// 使用UUID生成唯一文件名
String filename = UUID.randomUUID().toString() + extension;
```

### 4. 目录权限
```bash
# Linux/Mac
chmod 755 uploads
chmod 755 uploads/avatars

# 确保应用有读写权限
```

## 备份策略

### 1. 定期备份
```bash
# 备份上传目录
tar -czf uploads-backup-$(date +%Y%m%d).tar.gz uploads/

# 或使用rsync
rsync -av uploads/ /backup/uploads/
```

### 2. 云存储同步
```bash
# 同步到阿里云OSS
ossutil cp -r uploads/ oss://your-bucket/uploads/

# 同步到七牛云
qshell qupload upload-config.json
```

## 性能优化

### 1. CDN加速
- 将 uploads 目录配置到 CDN
- 修改 `getAvatarUrl()` 返回 CDN 地址

### 2. 图片压缩
- 上传时自动压缩
- 生成多种尺寸（缩略图、中图、原图）

### 3. 缓存策略
```java
// 设置缓存头
response.setHeader("Cache-Control", "max-age=31536000");
```

## 迁移方案

### 从Base64迁移到文件存储

```sql
-- 1. 备份数据
CREATE TABLE user_backup AS SELECT * FROM user;

-- 2. 清空avatar字段
UPDATE user SET avatar = NULL;

-- 3. 用户重新上传头像
-- 或编写脚本批量转换Base64到文件
```

### 批量转换脚本（可选）
```java
// 读取所有Base64头像
// 转换为文件保存
// 更新数据库为文件路径
```

## 故障排查

### 1. 上传失败
- 检查目录权限
- 检查磁盘空间
- 查看日志文件

### 2. 图片无法访问
- 检查静态资源配置
- 检查文件是否存在
- 检查URL路径

### 3. 文件过大
- 调整 `max-file-size` 配置
- 前端添加压缩

## 测试清单

- [ ] 执行SQL更新数据库字段
- [ ] 创建uploads目录（或自动创建）
- [ ] 重启后端服务
- [ ] 测试上传头像
- [ ] 验证文件保存到硬盘
- [ ] 验证数据库存储路径
- [ ] 测试头像显示
- [ ] 测试删除头像
- [ ] 测试文件访问权限

## 生产部署

### Nginx配置（可选）
```nginx
location /uploads/ {
    alias /var/www/cloudnote/uploads/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### Docker配置（可选）
```dockerfile
# 挂载上传目录
volumes:
  - ./uploads:/app/uploads
```

---

**实施时间**: 2024-12-20  
**版本**: v2.0  
**状态**: ✅ 准备就绪
