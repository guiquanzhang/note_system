# 🔧 问题诊断和修复指南

## 当前错误分析

### 错误 1: "用户不存在" (500)
```
📥 收到响应: /user/info {code: 500, message: '用户不存在', data: null}
```

**可能原因**:
1. Token 已过期
2. 数据库中没有对应的用户记录
3. 用户ID解析失败

**解决方案**:
```bash
# 方案 1: 重新登录
1. 清除浏览器缓存和 localStorage
2. 重新登录系统

# 方案 2: 检查数据库
USE cloudnote;
SELECT * FROM user;  -- 查看是否有用户数据
```

---

### 错误 2: "请输入用户名" 验证失败
```
更新失败: {username: Array(1)}
```

**原因**: 上传头像时，表单字段未初始化

**已修复**: ✅ 在 `selectAvatar` 函数中添加了字段初始化逻辑

---

### 错误 3: 分类列表加载失败
```
Uncaught (in promise) Error: 系统异常，请联系管理员
at category.js:50:22
```

**可能原因**:
1. 后端服务未启动
2. 数据库连接失败
3. 分类表数据异常

**解决方案**:
```bash
# 检查后端服务
# 查看后端控制台日志，看是否有错误信息

# 检查数据库
USE cloudnote;
SELECT * FROM category;  -- 查看分类数据
```

---

## 🚀 快速修复步骤

### 步骤 1: 清除前端缓存
打开浏览器控制台（F12），执行：
```javascript
localStorage.clear()
sessionStorage.clear()
location.reload()
```

### 步骤 2: 检查数据库
```sql
USE cloudnote;

-- 检查用户表
SELECT user_id, username, email, avatar FROM user;

-- 检查分类表
SELECT * FROM category;

-- 如果没有分类数据，插入默认分类
INSERT INTO category (category_name, user_id) VALUES 
('工作', 1),
('学习', 1),
('生活', 1);
```

### 步骤 3: 重启后端服务
1. 停止当前后端服务
2. 确认数据库已更新（avatar 字段改为 VARCHAR(500)）
3. 重新启动后端

### 步骤 4: 重新登录
1. 访问 http://localhost:5173
2. 使用正确的用户名和密码登录
3. 测试功能

---

## 🔍 详细诊断

### 检查 Token
打开浏览器控制台，执行：
```javascript
console.log('Token:', localStorage.getItem('token'))
```

如果 token 为 null 或格式不正确，需要重新登录。

### 检查后端日志
查看后端控制台输出，关注以下信息：
- 数据库连接是否成功
- SQL 执行是否有错误
- JWT token 解析是否正常

### 检查数据库字段
```sql
USE cloudnote;

-- 检查 user 表结构
DESC user;

-- 确认 avatar 字段类型
SHOW FULL COLUMNS FROM user WHERE Field = 'avatar';
-- 应该显示: VARCHAR(500)
```

---

## ✅ 验证修复

### 1. 用户信息加载
- [ ] 登录后能正常显示用户信息
- [ ] 个人信息页面不报错

### 2. 头像上传
- [ ] 点击"选择头像"能选择图片
- [ ] 上传成功显示提示
- [ ] 点击"保存"能成功更新
- [ ] 头像能正常显示

### 3. 分类列表
- [ ] 笔记列表页面能正常加载
- [ ] 分类筛选功能正常

---

## 🆘 如果问题仍然存在

### 完全重置方案

#### 1. 清除所有前端数据
```javascript
// 浏览器控制台执行
localStorage.clear()
sessionStorage.clear()
indexedDB.deleteDatabase('cloudnote')
location.reload()
```

#### 2. 重置数据库（谨慎！）
```sql
USE cloudnote;

-- 备份数据
CREATE TABLE user_backup AS SELECT * FROM user;
CREATE TABLE note_backup AS SELECT * FROM note;

-- 删除所有数据
TRUNCATE TABLE note;
TRUNCATE TABLE category;
DELETE FROM user;

-- 重新注册用户
-- 然后通过前端注册新用户
```

#### 3. 检查端口占用
```bash
# Windows
netstat -ano | findstr :8080
netstat -ano | findstr :5173

# 如果端口被占用，结束进程或更换端口
```

---

## 📝 常见问题 FAQ

### Q: 为什么会出现"用户不存在"？
A: 通常是 token 过期或数据库中没有对应用户。重新登录即可解决。

### Q: 头像上传成功但保存失败？
A: 检查数据库 avatar 字段是否已改为 VARCHAR(500)。

### Q: 图片上传后无法显示？
A: 检查后端 WebConfig 配置和 uploads 目录权限。

### Q: 分类列表加载失败？
A: 检查数据库 category 表是否有数据，后端服务是否正常运行。

---

## 🎯 推荐操作顺序

1. **清除浏览器缓存** → 重新登录
2. **检查数据库字段** → 确认 avatar 为 VARCHAR(500)
3. **重启后端服务** → 查看启动日志
4. **测试头像上传** → 验证功能正常

---

**如果以上方法都无法解决，请提供：**
1. 后端控制台完整错误日志
2. 浏览器控制台完整错误信息
3. 数据库表结构（DESC user; DESC category;）
