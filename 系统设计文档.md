# CloudNote 云笔记系统 - 系统设计文档

## 1. 系统概述

### 1.1 项目简介
CloudNote 是一个基于 Spring Boot + Vue 3 的现代化云笔记管理系统，提供笔记的创建、编辑、分类、标签管理、回收站等功能，支持富文本编辑和图片上传。

### 1.2 技术栈

#### 后端技术栈
- **框架**: Spring Boot 2.7.18
- **JDK**: 1.8
- **ORM**: MyBatis Plus 3.5.3.1
- **数据库**: MySQL 8.0
- **认证**: JWT (jjwt 0.11.5)
- **工具类**: Hutool 5.8.20
- **构建工具**: Maven 3.x

#### 前端技术栈
- **框架**: Vue 3.4.21
- **构建工具**: Vite 5.2.0
- **UI 组件**: Element Plus 2.12.0
- **状态管理**: Pinia 2.3.1
- **路由**: Vue Router 4.6.4
- **HTTP 客户端**: Axios 1.13.2
- **富文本编辑器**: Quill 2.0.3 (@vueup/vue-quill 1.2.0)

### 1.3 系统特性
- 用户注册登录（JWT 认证）
- 笔记 CRUD 操作
- 富文本编辑（支持图片上传）
- 分类管理
- 标签系统（独立标签表 + 关联表）
- 回收站（软删除机制）
- 笔记搜索
- 响应式设计
- iPhone 风格 UI

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                      前端层 (Vue 3)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │ 登录注册 │  │ 笔记管理 │  │ 分类标签 │  │ 个人中心│ │
│  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │
│         │              │              │            │     │
│         └──────────────┴──────────────┴────────────┘     │
│                        │ Axios                            │
└────────────────────────┼────────────────────────────────┘
                         │ HTTP/JSON
┌────────────────────────┼────────────────────────────────┐
│                        ▼                                 │
│              ┌──────────────────┐                        │
│              │  JWT 拦截器      │                        │
│              └──────────────────┘                        │
│                        │                                 │
│              ┌──────────────────┐                        │
│              │  Controller 层   │                        │
│              │  (REST API)      │                        │
│              └──────────────────┘                        │
│                        │                                 │
│              ┌──────────────────┐                        │
│              │   Service 层     │                        │
│              │  (业务逻辑)      │                        │
│              └──────────────────┘                        │
│                        │                                 │
│              ┌──────────────────┐                        │
│              │   Mapper 层      │                        │
│              │  (MyBatis Plus)  │                        │
│              └──────────────────┘                        │
│                        │                                 │
│                 后端层 (Spring Boot)                     │
└────────────────────────┼────────────────────────────────┘
                         │ JDBC
┌────────────────────────┼────────────────────────────────┐
│                        ▼                                 │
│                  MySQL 数据库                            │
│  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────────┐ │
│  │ user │  │ note │  │category│ │ tag  │  │ note_tag │ │
│  └──────┘  └──────┘  └──────┘  └──────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 2.2 分层架构

#### Controller 层
- 职责：接收 HTTP 请求，参数校验，调用 Service，返回响应
- 特点：RESTful API 设计，统一返回格式 Result<T>

#### Service 层
- 职责：业务逻辑处理，事务管理
- 特点：接口 + 实现类，便于扩展和测试

#### Mapper 层
- 职责：数据访问，SQL 执行
- 特点：基于 MyBatis Plus，支持自定义 SQL

#### Entity 层
- 职责：数据库表映射
- 特点：使用 Lombok 简化代码

### 2.3 核心模块

```
cloudnote
├── common          # 公共模块
│   └── Result      # 统一响应结果
├── config          # 配置模块
│   └── WebConfig   # Web 配置（拦截器、静态资源）
├── context         # 上下文模块
│   └── UserContext # 用户上下文（ThreadLocal）
├── controller      # 控制器层
│   ├── UserController
│   ├── NoteController
│   ├── CategoryController
│   ├── TagController
│   └── FileController
├── dto             # 数据传输对象
│   ├── LoginDTO
│   ├── RegisterDTO
│   ├── NoteDTO
│   └── TagDTO
├── entity          # 实体类
│   ├── User
│   ├── Note
│   ├── Category
│   ├── Tag
│   └── NoteTag
├── exception       # 异常处理
│   └── GlobalExceptionHandler
├── interceptor     # 拦截器
│   └── JwtInterceptor
├── mapper          # 数据访问层
│   ├── UserMapper
│   ├── NoteMapper
│   ├── CategoryMapper
│   ├── TagMapper
│   └── NoteTagMapper
├── service         # 业务逻辑层
│   ├── UserService
│   ├── NoteService
│   ├── CategoryService
│   └── TagService
├── util            # 工具类
│   └── JwtUtil
└── vo              # 视图对象
    ├── LoginVO
    ├── NoteVO
    └── TagVO
```

## 3. 数据库设计

### 3.1 ER 图

```
┌─────────────────┐
│      user       │
│─────────────────│
│ PK user_id      │
│    username     │
│    password     │
│    nickname     │
│    email        │
│    avatar       │
│    created_at   │
│    updated_at   │
└─────────────────┘
         │ 1
         │
         │ *
┌─────────────────┐         ┌─────────────────┐
│    category     │         │       tag       │
│─────────────────│         │─────────────────│
│ PK category_id  │         │ PK tag_id       │
│    name         │         │    name         │
│ FK user_id      │         │    color        │
│    created_at   │         │ FK user_id      │
│    updated_at   │         │    created_at   │
└─────────────────┘         │    updated_at   │
         │ 1                └─────────────────┘
         │                           │ 1
         │ *                         │
┌─────────────────┐                 │
│      note       │                 │
│─────────────────│                 │
│ PK note_id      │                 │
│    title        │                 │
│    content      │                 │
│ FK user_id      │                 │
│ FK category_id  │                 │
│    tags         │                 │
│    deleted      │                 │
│    deleted_at   │                 │
│    created_at   │                 │
│    updated_at   │                 │
└─────────────────┘                 │
         │ *                        │
         │                          │ *
         │                 ┌─────────────────┐
         └─────────────────│    note_tag     │
                           │─────────────────│
                           │ PK id           │
                           │ FK note_id      │
                           │ FK tag_id       │
                           │    created_at   │
                           └─────────────────┘
```

### 3.2 表结构说明

#### user 表（用户表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| user_id | INT | 用户ID | PK, AUTO_INCREMENT |
| username | VARCHAR(100) | 用户名 | NOT NULL, UNIQUE |
| password | VARCHAR(255) | 密码（加密） | NOT NULL |
| nickname | VARCHAR(100) | 昵称 | NULL |
| email | VARCHAR(100) | 邮箱 | NULL |
| avatar | VARCHAR(500) | 头像URL | NULL |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

#### category 表（分类表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| category_id | INT | 分类ID | PK, AUTO_INCREMENT |
| name | VARCHAR(100) | 分类名称 | NOT NULL |
| user_id | INT | 用户ID | FK -> user(user_id) |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

#### note 表（笔记表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| note_id | INT | 笔记ID | PK, AUTO_INCREMENT |
| title | VARCHAR(255) | 笔记标题 | NOT NULL |
| content | LONGTEXT | 笔记内容（HTML） | NULL |
| user_id | INT | 用户ID | FK -> user(user_id) |
| category_id | INT | 分类ID | FK -> category(category_id) |
| tags | VARCHAR(255) | 标签（逗号分隔，已废弃） | NULL |
| deleted | TINYINT | 是否删除：0-否，1-是 | DEFAULT 0 |
| deleted_at | TIMESTAMP | 删除时间 | NULL |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

#### tag 表（标签表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| tag_id | INT | 标签ID | PK, AUTO_INCREMENT |
| name | VARCHAR(50) | 标签名称 | NOT NULL |
| color | VARCHAR(20) | 标签颜色 | DEFAULT '#409EFF' |
| user_id | INT | 用户ID | FK -> user(user_id) |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**唯一约束**: (user_id, name) - 同一用户不能创建重名标签

#### note_tag 表（笔记标签关联表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 主键ID | PK, AUTO_INCREMENT |
| note_id | INT | 笔记ID | FK -> note(note_id) |
| tag_id | INT | 标签ID | FK -> tag(tag_id) |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |

**唯一约束**: (note_id, tag_id) - 同一笔记不能关联同一标签多次

### 3.3 索引设计
```sql
-- user 表
INDEX idx_username (username)

-- category 表
INDEX idx_user_id (user_id)

-- note 表
INDEX idx_user_id (user_id)
INDEX idx_category_id (category_id)
INDEX idx_user_deleted (user_id, deleted)  -- 优化查询
FULLTEXT INDEX idx_title_content (title, content)  -- 全文搜索

-- tag 表
INDEX idx_user_id (user_id)
INDEX idx_user_name (user_id, name)  -- 优化查询

-- note_tag 表
INDEX idx_note_id (note_id)
INDEX idx_tag_id (tag_id)
```

## 4. 权限流程设计

### 4.1 认证流程

```
┌──────────┐                                    ┌──────────┐
│  客户端  │                                    │  服务端  │
└──────────┘                                    └──────────┘
     │                                                │
     │  1. POST /user/login                          │
     │    { username, password }                     │
     ├──────────────────────────────────────────────>│
     │                                                │
     │                                    2. 验证用户名密码
     │                                                │
     │                                    3. 生成 JWT Token
     │                                                │
     │  4. 返回 Token                                │
     │    { code: 200, data: { token, user } }       │
     │<──────────────────────────────────────────────┤
     │                                                │
     │  5. 存储 Token 到 localStorage                │
     │                                                │
     │  6. 后续请求携带 Token                        │
     │    Header: Authorization: Bearer <token>      │
     ├──────────────────────────────────────────────>│
     │                                                │
     │                                    7. JWT 拦截器验证
     │                                                │
     │                                    8. 提取 userId
     │                                                │
     │                                    9. 存入 UserContext
     │                                                │
     │                                    10. 执行业务逻辑
     │                                                │
     │  11. 返回结果                                 │
     │<──────────────────────────────────────────────┤
     │                                                │
```

### 4.2 JWT 拦截器流程

```java
// JwtInterceptor.preHandle()
1. 从请求头获取 Authorization
2. 检查是否以 "Bearer " 开头
3. 提取 Token（去掉 "Bearer " 前缀）
4. 调用 JwtUtil.validateToken() 验证
5. 如果验证失败，返回 401
6. 如果验证成功：
   - 提取 userId
   - 存入 request.attribute
   - 存入 UserContext（ThreadLocal）
7. 放行请求

// JwtInterceptor.afterCompletion()
1. 清除 UserContext（防止内存泄漏）
```

### 4.3 权限控制

#### 路径级别权限
```java
// WebConfig.java
registry.addInterceptor(jwtInterceptor)
    .addPathPatterns("/**")  // 拦截所有请求
    .excludePathPatterns(    // 排除不需要认证的路径
        "/user/login",       // 登录
        "/user/register",    // 注册
        "/uploads/**",       // 静态资源
        "/error"             // 错误页面
    );
```

#### 数据级别权限
所有业务操作都会验证数据所有权：

```java
// 示例：NoteService.getById()
public NoteVO getById(Integer noteId) {
    Integer userId = UserContext.getUserId();  // 从上下文获取当前用户
    Note note = noteMapper.selectById(noteId);
    
    if (note == null) {
        throw new RuntimeException("笔记不存在");
    }
    
    // 验证所有权
    if (!note.getUserId().equals(userId)) {
        throw new RuntimeException("无权限访问");
    }
    
    return convertToVO(note);
}
```

### 4.4 用户上下文

```java
// UserContext.java - 使用 ThreadLocal 存储当前用户信息
public class UserContext {
    private static final ThreadLocal<Integer> userIdHolder = new ThreadLocal<>();
    
    public static void setUserId(Integer userId) {
        userIdHolder.set(userId);
    }
    
    public static Integer getUserId() {
        return userIdHolder.get();
    }
    
    public static void clear() {
        userIdHolder.remove();
    }
}
```

**优点**：
- 线程安全
- 无需在方法间传递 userId
- 自动清理（拦截器 afterCompletion）

## 5. 异常处理机制

### 5.1 异常处理架构

```
┌─────────────────────────────────────────────────────────┐
│                    Controller 层                         │
│                         │                                │
│                         ▼                                │
│                    Service 层                            │
│                         │                                │
│                         ▼                                │
│                    Mapper 层                             │
│                         │                                │
│                         ▼                                │
│                  抛出异常 (Exception)                    │
│                         │                                │
└─────────────────────────┼───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│            GlobalExceptionHandler                        │
│            (@RestControllerAdvice)                       │
│                                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │ @ExceptionHandler(RuntimeException.class)       │   │
│  │ 处理业务异常                                    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │ @ExceptionHandler(MethodArgumentNotValidException)│ │
│  │ 处理参数校验异常                                │   │
│  └─────────────────────────────────────────────────┘   │
│                                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │ @ExceptionHandler(Exception.class)              │   │
│  │ 处理其他未知异常                                │   │
│  └─────────────────────────────────────────────────┘   │
│                                                           │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
                  返回统一格式 Result<Void>
                  { code: 500, message: "错误信息" }
```

### 5.2 异常分类

#### 业务异常（RuntimeException）
```java
// 示例
if (note == null) {
    throw new RuntimeException("笔记不存在");
}

if (!note.getUserId().equals(userId)) {
    throw new RuntimeException("无权限访问");
}
```

**处理方式**：
```java
@ExceptionHandler(RuntimeException.class)
public Result<Void> handleRuntimeException(RuntimeException e) {
    log.error("业务异常：", e);
    return Result.error(e.getMessage());  // 返回异常消息
}
```

#### 参数校验异常
```java
// DTO 中使用注解
public class RegisterDTO {
    @NotBlank(message = "用户名不能为空")
    @Size(min = 3, max = 20, message = "用户名长度必须在3-20之间")
    private String username;
    
    @NotBlank(message = "密码不能为空")
    @Size(min = 6, message = "密码长度不能少于6位")
    private String password;
}
```

**处理方式**：
```java
@ExceptionHandler({MethodArgumentNotValidException.class, BindException.class})
public Result<Void> handleValidException(Exception e) {
    String message = "参数校验失败";
    if (e instanceof MethodArgumentNotValidException) {
        message = ((MethodArgumentNotValidException) e)
            .getBindingResult()
            .getAllErrors()
            .get(0)
            .getDefaultMessage();
    }
    return Result.error(400, message);
}
```

#### 系统异常（Exception）
```java
@ExceptionHandler(Exception.class)
public Result<Void> handleException(Exception e) {
    log.error("系统异常：", e);
    return Result.error("系统异常，请联系管理员");  // 不暴露详细信息
}
```

### 5.3 统一响应格式

```java
@Data
public class Result<T> {
    private Integer code;    // 状态码
    private String message;  // 消息
    private T data;          // 数据

    // 成功响应
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("操作成功");
        result.setData(data);
        return result;
    }

    // 失败响应
    public static <T> Result<T> error(String message) {
        Result<T> result = new Result<>();
        result.setCode(500);
        result.setMessage(message);
        return result;
    }
}
```

**响应示例**：
```json
// 成功
{
  "code": 200,
  "message": "操作成功",
  "data": { ... }
}

// 失败
{
  "code": 500,
  "message": "笔记不存在",
  "data": null
}
```

### 5.4 前端异常处理

```javascript
// request.js - Axios 响应拦截器
service.interceptors.response.use(
  response => {
    const res = response.data
    
    // 业务失败
    if (res.code !== 200) {
      ElMessage.error(res.message || '操作失败')
      
      // 401 未授权，跳转登录
      if (res.code === 401) {
        router.push('/login')
      }
      
      return Promise.reject(new Error(res.message || '操作失败'))
    }
    
    return res
  },
  error => {
    // HTTP 错误
    ElMessage.error(error.message || '网络错误')
    return Promise.reject(error)
  }
)
```

## 6. 核心业务流程

### 6.1 用户注册流程
```
1. 前端提交注册表单（username, password, email）
2. 后端参数校验（@Valid）
3. 检查用户名是否已存在
4. 密码加密（BCrypt）
5. 保存用户到数据库
6. 返回成功响应
```

### 6.2 用户登录流程
```
1. 前端提交登录表单（username, password）
2. 后端查询用户
3. 验证密码（BCrypt.matches）
4. 生成 JWT Token
5. 返回 Token 和用户信息
6. 前端存储 Token 到 localStorage
7. 设置 Axios 默认 Header
```

### 6.3 笔记创建流程
```
1. 前端提交笔记数据（title, content, categoryId, tagIds）
2. JWT 拦截器验证 Token，提取 userId
3. 保存笔记到数据库
4. 处理标签关联：
   - 删除旧的关联关系
   - 创建新的关联关系（note_tag 表）
5. 返回笔记 ID
```

### 6.4 图片上传流程
```
1. 用户在编辑器中插入图片
2. 触发自定义上传处理器
3. 调用 /file/upload/note-image 接口
4. 后端保存文件到 uploads/notes/ 目录
5. 返回相对路径：/uploads/notes/xxx.jpg
6. 前端将路径插入编辑器
7. 显示时拼接 /api 前缀：/api/uploads/notes/xxx.jpg
```

### 6.5 回收站流程
```
删除笔记：
1. 设置 deleted = 1
2. 设置 deleted_at = 当前时间
3. MyBatis Plus 自动过滤已删除笔记

恢复笔记：
1. 使用自定义 SQL 绕过逻辑删除
2. 设置 deleted = 0
3. 设置 deleted_at = NULL

永久删除：
1. 使用自定义 SQL 物理删除
2. 级联删除关联的标签关系
```

### 6.6 标签管理流程
```
创建标签：
1. 检查标签名是否已存在（同一用户）
2. 保存到 tag 表

笔记关联标签：
1. 删除旧的关联关系（note_tag 表）
2. 批量插入新的关联关系
3. 如果标签不存在，自动创建

查询笔记标签：
1. 通过 note_tag 表关联查询
2. 返回标签列表
```

## 7. 性能优化

### 7.1 数据库优化
- 合理使用索引
- 避免 N+1 查询
- 使用分页查询
- 定期清理回收站数据

### 7.2 缓存策略
- 前端：静态资源缓存（1年）
- 后端：可考虑 Redis 缓存热点数据

### 7.3 文件上传优化
- 限制文件大小（10MB）
- 图片压缩（前端）
- CDN 加速（生产环境）

## 8. 安全设计

### 8.1 认证安全
- JWT Token 有效期：7天
- Token 存储：localStorage
- 密码加密：BCrypt

### 8.2 权限安全
- 所有接口验证 Token
- 数据级别权限控制
- 防止越权访问

### 8.3 输入安全
- 参数校验（@Valid）
- SQL 注入防护（MyBatis Plus）
- XSS 防护（前端转义）

### 8.4 文件安全
- 文件类型限制
- 文件大小限制
- 文件名随机化（UUID）

## 9. 扩展性设计

### 9.1 水平扩展
- 无状态设计（JWT）
- 支持负载均衡
- 文件存储可迁移到 OSS

### 9.2 功能扩展
- 笔记分享
- 协作编辑
- 笔记导出（PDF、Markdown）
- 笔记模板
- 笔记版本控制

## 10. 技术亮点

1. **标签系统重构**：从字符串存储改为独立表 + 关联表，支持标签管理和笔记的双向同步
2. **软删除机制**：使用 MyBatis Plus 逻辑删除 + 自定义 SQL 实现回收站功能
3. **图片上传优化**：从 Base64 改为服务器存储，支持大量图片
4. **JWT 认证**：无状态认证，支持分布式部署
5. **统一异常处理**：全局异常处理器，统一响应格式
6. **用户上下文**：ThreadLocal 实现，简化权限控制
7. **iPhone 风格 UI**：现代化设计，流畅动画，毛玻璃效果
8. **富文本编辑器**：Quill 集成，支持图片上传和自定义工具栏

## 11. 未来规划

- [ ] 笔记分享功能
- [ ] 笔记导出（PDF、Markdown）
- [ ] 笔记模板
- [ ] 协作编辑
- [ ] 移动端适配
- [ ] 暗黑模式
- [ ] 笔记版本控制
- [ ] 全文搜索优化（Elasticsearch）
- [ ] 文件存储迁移到 OSS
- [ ] 消息通知系统
