# 图片显示问题 - 完整修复步骤

## 问题分析

图片 URL 显示为 `http://localhost:5173/api/undefined/uploads/notes/xxx.jpg`，说明：
1. 数据库中可能已经存储了错误的 URL（包含 `undefined`）
2. 需要修复数据库中的数据
3. 需要确保前端代码正确处理 URL

## 修复步骤

### 步骤 1：修复数据库中的错误 URL

在 MySQL 中执行：

```sql
USE cloudnote;

-- 查看当前有问题的笔记
SELECT note_id, title, SUBSTRING(content, 1, 300) 
FROM note 
WHERE content LIKE '%<img%' AND user_id = 7;

-- 修复 undefined URL
UPDATE note 
SET content = REPLACE(content, '/api/undefined/uploads/', '/uploads/')
WHERE content LIKE '%/api/undefined/uploads/%' AND user_id = 7;

-- 修复 /api/ 前缀
UPDATE note 
SET content = REPLACE(content, 'src="/api/uploads/', 'src="/uploads/')
WHERE content LIKE '%src="/api/uploads/%' AND user_id = 7;

-- 验证修复结果
SELECT note_id, title, SUBSTRING(content, 1, 300) 
FROM note 
WHERE content LIKE '%<img%' AND user_id = 7;
```

或者直接执行 SQL 文件：
```bash
mysql -u root -p cloudnote < 修复图片URL.sql
```

### 步骤 2：刷新前端

在浏览器中按 **Ctrl+F5** 强制刷新

### 步骤 3：测试显示

1. 打开包含图片的笔记（note_id = 23）
2. 打开浏览器开发者工具（F12）→ Console
3. 查看日志输出：
   - `原始内容:` 应该显示 `<img src="/uploads/notes/xxx.jpg">`
   - `处理后内容:` 应该显示 `<img src="/api/uploads/notes/xxx.jpg">`
4. 查看 Network 面板：
   - 应该请求 `/api/uploads/notes/xxx.jpg`
   - 状态应该是 200（不是 401 或 404）

### 步骤 4：测试新建笔记

1. 新建笔记
2. 插入图片
3. 保存
4. 查看详情 → 图片应该正常显示

### 步骤 5：验证数据库

```sql
-- 查看最新笔记的内容
SELECT note_id, title, content 
FROM note 
WHERE user_id = 7 
ORDER BY created_at DESC 
LIMIT 1;
```

**预期结果**：
- content 应该包含：`<img src="/uploads/notes/xxx.jpg">`
- 不应该包含：`/api/`、`undefined`、完整 URL

## 数据流程（正确的）

### 上传图片
1. 用户选择图片
2. 调用 `uploadNoteImage()` → 返回 `/uploads/notes/xxx.jpg`
3. 拼接 `/api` → `/api/uploads/notes/xxx.jpg`
4. 插入编辑器

### 保存笔记
1. 编辑器内容：`<img src="/api/uploads/notes/xxx.jpg">`
2. `normalizeContent()` 转换：`<img src="/uploads/notes/xxx.jpg">`
3. 存入数据库

### 显示笔记
1. 从数据库读取：`<img src="/uploads/notes/xxx.jpg">`
2. `processNoteContent()` 转换：`<img src="/api/uploads/notes/xxx.jpg">`
3. 浏览器请求：`/api/uploads/notes/xxx.jpg`
4. Vite 代理到：`http://localhost:8080/api/uploads/notes/xxx.jpg`
5. 后端返回图片文件

## 常见问题排查

### Q1: 还是显示 undefined
**原因**：数据库中的数据没有修复
**解决**：执行步骤 1 的 SQL 修复脚本

### Q2: 图片 404
**原因**：图片文件不存在
**检查**：
```bash
# Windows
dir uploads\notes
```
应该能看到 `704c1e40-62be-421e-bfc7-6452b2878478.jpg`

### Q3: 图片 401 Unauthorized
**原因**：静态资源访问需要认证
**解决**：检查 `WebConfig.java` 是否配置了静态资源路径

### Q4: 编辑器中图片不显示
**原因**：`processNoteContent()` 没有正确转换
**检查**：浏览器 Console 中的日志输出

## 验证清单

- [ ] 执行 SQL 修复脚本
- [ ] 刷新浏览器（Ctrl+F5）
- [ ] 打开笔记 23，查看 Console 日志
- [ ] 图片正常显示
- [ ] 新建笔记，插入图片，保存
- [ ] 新笔记的图片也正常显示
- [ ] 数据库中只存相对路径 `/uploads/notes/xxx.jpg`

## 如果还是不行

请提供以下信息：

1. **数据库内容**：
```sql
SELECT content FROM note WHERE note_id = 23;
```

2. **浏览器 Console 日志**：
   - 原始内容
   - 处理后内容

3. **Network 请求**：
   - 请求的完整 URL
   - 响应状态码

4. **文件是否存在**：
```bash
dir uploads\notes\704c1e40-62be-421e-bfc7-6452b2878478.jpg
```
