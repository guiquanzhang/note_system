# 头像上传功能部署指南

## ✅ 已完成的工作

### 1. 后端实现
- ✅ 创建 `FileController.java` - 文件上传控制器
- ✅ 创建 `WebConfig.java` - 静态资源映射配置
- ✅ 更新 `application.yml` - 文件上传配置
- ✅ 所有代码无编译错误

### 2. 前端实现
- ✅ 创建 `file.js` API - 文件上传接口
- ✅ 更新 `Profile.vue` - 头像上传功能
- ✅ 图片上传到服务器，不再使用 Base64

### 3. 数据库脚本
- ✅ 创建 `更新头像字段为URL.sql` - 修改 avatar 字段类型

---

## 🚀 部署步骤

### 步骤 1: 更新数据库
执行以下 SQL 语句：

```sql
USE cloudnote;

-- 将 avatar 字段改为 VARCHAR(500)
ALTER TABLE `user` 
MODIFY COLUMN `avatar` VARCHAR(500) COMMENT '用户头像URL';

-- 验证修改
DESC `user`;
```

### 步骤 2: 重启后端服务
1. 停止当前运行的后端服务
2. 重新启动后端（Spring Boot 会自动创建 `uploads/avatars/` 目录）

### 步骤 3: 测试功能
1. 访问前端：http://localhost:5173
2. 登录后进入"个人信息"页面
3. 点击"编辑信息"
4. 点击"选择头像"上传图片
5. 点击"保存"按钮

---

## 📁 文件存储说明

### 存储位置
- **开发环境**: 项目根目录 `/uploads/avatars/`
- **生产环境**: 可在 `application.yml` 中配置绝对路径

### 文件命名
- 使用 UUID 生成唯一文件名，例如：`abc123-def456.jpg`
- 保留原始文件扩展名

### 访问方式
- **存储路径**: `/uploads/avatars/abc123.jpg`
- **访问URL**: `http://localhost:8080/uploads/avatars/abc123.jpg`
- **数据库存储**: `/uploads/avatars/abc123.jpg`（相对路径）

---

## 🔧 配置说明

### application.yml 配置
```yaml
# 文件上传配置
spring:
  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB      # 单个文件最大 10MB
      max-request-size: 10MB   # 请求最大 10MB

# 自定义配置
file:
  upload:
    path: uploads              # 文件上传目录（相对路径）
  access:
    url: /uploads              # 文件访问URL前缀
```

### 文件限制
- **文件类型**: 仅支持图片（image/*）
- **文件大小**: 最大 5MB（在 FileController 中限制）
- **支持格式**: jpg, jpeg, png, gif, webp 等

---

## ✨ 功能特点

### 1. 安全性
- ✅ 文件类型验证（仅允许图片）
- ✅ 文件大小限制（5MB）
- ✅ 唯一文件名（防止覆盖）

### 2. 性能优化
- ✅ 数据库只存储路径（不存储 Base64）
- ✅ 文件直接存储到硬盘
- ✅ 支持静态资源访问

### 3. 用户体验
- ✅ 实时预览头像
- ✅ 上传进度提示
- ✅ 错误提示友好

---

## 🐛 常见问题

### 问题 1: 上传后无法访问图片
**原因**: 静态资源映射未生效
**解决**: 
1. 检查 `WebConfig.java` 是否正确配置
2. 重启后端服务
3. 确认 `uploads/avatars/` 目录存在

### 问题 2: 数据库报错 "Data too long"
**原因**: avatar 字段类型仍为 TEXT
**解决**: 执行 SQL 更新语句，将字段改为 VARCHAR(500)

### 问题 3: 图片上传失败
**原因**: 文件大小超限或类型不支持
**解决**: 
1. 检查图片大小是否超过 5MB
2. 确认文件类型为图片格式

---

## 📊 数据库字段对比

### 修改前
```sql
`avatar` TEXT COMMENT '用户头像（Base64）'
```
- 存储内容: Base64 编码的图片数据
- 字段大小: 最大 64KB
- 问题: 超过限制会报错

### 修改后
```sql
`avatar` VARCHAR(500) COMMENT '用户头像URL'
```
- 存储内容: 文件路径，如 `/uploads/avatars/abc123.jpg`
- 字段大小: 最大 500 字符
- 优点: 数据库体积小，查询速度快

---

## 🎯 下一步优化建议

### 1. 图片压缩
- 前端上传前自动压缩图片
- 减少文件大小，提升上传速度

### 2. CDN 加速
- 将图片上传到 OSS（阿里云、腾讯云）
- 使用 CDN 加速图片访问

### 3. 图片裁剪
- 支持用户裁剪头像
- 统一头像尺寸（如 200x200）

### 4. 旧文件清理
- 定期清理未使用的图片文件
- 节省存储空间

---

## 📝 测试清单

- [ ] 执行数据库更新 SQL
- [ ] 重启后端服务
- [ ] 上传头像（小于 5MB）
- [ ] 验证图片保存到 `uploads/avatars/` 目录
- [ ] 验证数据库存储文件路径
- [ ] 验证图片可以正常访问
- [ ] 测试移除头像功能
- [ ] 测试上传超大文件（应该报错）
- [ ] 测试上传非图片文件（应该报错）

---

## 🎉 完成！

按照以上步骤操作后，头像上传功能即可正常使用。如有问题，请检查：
1. 数据库字段是否已更新
2. 后端服务是否已重启
3. `uploads/avatars/` 目录是否存在
4. 控制台是否有错误日志
