# CloudNote 云笔记系统 - 部署手册

## 1. 系统要求

### 1.1 硬件要求
- CPU: 2核及以上
- 内存: 4GB及以上
- 磁盘: 20GB及以上可用空间

### 1.2 软件要求
- 操作系统: Windows/Linux/MacOS
- JDK: 1.8 或更高版本
- Maven: 3.6 或更高版本
- MySQL: 8.0 或更高版本
- Node.js: 16.0 或更高版本
- npm: 8.0 或更高版本

## 2. 环境准备

### 2.1 安装 JDK 1.8
```bash
# 验证安装
java -version
```

### 2.2 安装 Maven
```bash
# 验证安装
mvn -version
```

### 2.3 安装 MySQL 8.0
```bash
# 验证安装
mysql --version
```

### 2.4 安装 Node.js 和 npm
```bash
# 验证安装
node -v
npm -v
```

## 3. 数据库部署

### 3.1 创建数据库
```sql
CREATE DATABASE IF NOT EXISTS cloudnote 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

### 3.2 执行数据库脚本
执行项目中的 `src/main/resources/db/schema.sql` 文件创建表结构：

```bash
mysql -u root -p cloudnote < src/main/resources/db/schema.sql
```

### 3.3 创建标签表（重要）
由于标签系统是后期添加的功能，需要单独执行以下 SQL：

```sql
USE cloudnote;

-- 标签表
CREATE TABLE IF NOT EXISTS `tag` (
  `tag_id` INT AUTO_INCREMENT PRIMARY KEY,
  `name` VARCHAR(50) NOT NULL COMMENT '标签名称',
  `color` VARCHAR(20) DEFAULT '#409EFF' COMMENT '标签颜色',
  `user_id` INT NOT NULL COMMENT '用户ID',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  UNIQUE KEY `uk_user_name` (`user_id`, `name`),
  INDEX `idx_user_id` (`user_id`),
  FOREIGN KEY (`user_id`) REFERENCES `user`(`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签表';

-- 笔记标签关联表
CREATE TABLE IF NOT EXISTS `note_tag` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `note_id` INT NOT NULL COMMENT '笔记ID',
  `tag_id` INT NOT NULL COMMENT '标签ID',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  UNIQUE KEY `uk_note_tag` (`note_id`, `tag_id`),
  INDEX `idx_note_id` (`note_id`),
  INDEX `idx_tag_id` (`tag_id`),
  FOREIGN KEY (`note_id`) REFERENCES `note`(`note_id`) ON DELETE CASCADE,
  FOREIGN KEY (`tag_id`) REFERENCES `tag`(`tag_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='笔记标签关联表';
```

### 3.4 更新笔记表字段
确保笔记表包含必要的字段：

```sql
-- 添加软删除字段（如果不存在）
ALTER TABLE `note` 
ADD COLUMN IF NOT EXISTS `deleted` TINYINT DEFAULT 0 COMMENT '是否删除：0-否，1-是';

ALTER TABLE `note` 
ADD COLUMN IF NOT EXISTS `deleted_at` TIMESTAMP NULL COMMENT '删除时间';

-- 修改 content 字段为 LONGTEXT 以支持大量图片
ALTER TABLE `note` 
MODIFY COLUMN `content` LONGTEXT COMMENT '笔记内容';
```

### 3.5 更新用户表字段
```sql
-- 添加昵称和头像字段（如果不存在）
ALTER TABLE `user` 
ADD COLUMN IF NOT EXISTS `nickname` VARCHAR(100) COMMENT '昵称';

ALTER TABLE `user` 
ADD COLUMN IF NOT EXISTS `avatar` VARCHAR(500) COMMENT '头像URL';
```

## 4. 后端部署

### 4.1 配置数据库连接
编辑 `src/main/resources/application.yml`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/cloudnote?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: root
    password: 你的数据库密码
```

### 4.2 配置文件上传路径
在 `application.yml` 中配置：

```yaml
file:
  upload:
    path: uploads  # 相对路径，会在项目根目录创建
    # 或使用绝对路径：path: /var/cloudnote/uploads
```

### 4.3 编译打包
```bash
# 进入项目根目录
cd cloudnote

# 清理并打包
mvn clean package -DskipTests
```

### 4.4 运行后端服务
```bash
# 方式1：直接运行 jar 包
java -jar target/cloudnote-1.0.0.jar

# 方式2：使用 Maven 运行
mvn spring-boot:run

# 方式3：后台运行（Linux）
nohup java -jar target/cloudnote-1.0.0.jar > cloudnote.log 2>&1 &
```

### 4.5 验证后端服务
访问：http://localhost:8080/api
如果看到 404 页面（而不是连接错误），说明服务已启动。

## 5. 前端部署

### 5.1 安装依赖
```bash
# 进入前端目录
cd front_end

# 安装依赖
npm install
```

### 5.2 配置后端接口地址

#### 开发环境配置
编辑 `front_end/.env.development`：
```
VITE_API_BASE_URL=http://localhost:8080
```

#### 生产环境配置
编辑 `front_end/.env.production`：
```
VITE_API_BASE_URL=http://你的服务器IP:8080
```

### 5.3 开发模式运行
```bash
npm run dev
```
访问：http://localhost:5173

### 5.4 生产环境打包
```bash
npm run build
```
打包后的文件在 `front_end/dist` 目录。

### 5.5 部署到 Nginx

#### 安装 Nginx
```bash
# Ubuntu/Debian
sudo apt-get install nginx

# CentOS/RHEL
sudo yum install nginx
```

#### 配置 Nginx
创建配置文件 `/etc/nginx/conf.d/cloudnote.conf`：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或IP

    # 前端静态文件
    location / {
        root /var/www/cloudnote/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 文件上传大小限制
        client_max_body_size 10M;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        root /var/www/cloudnote/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 部署前端文件
```bash
# 创建部署目录
sudo mkdir -p /var/www/cloudnote

# 复制打包文件
sudo cp -r front_end/dist/* /var/www/cloudnote/dist/

# 设置权限
sudo chown -R nginx:nginx /var/www/cloudnote
```

#### 重启 Nginx
```bash
# 测试配置
sudo nginx -t

# 重启服务
sudo systemctl restart nginx
```

## 6. 生产环境优化

### 6.1 后端服务配置

#### 使用 systemd 管理服务（Linux）
创建服务文件 `/etc/systemd/system/cloudnote.service`：

```ini
[Unit]
Description=CloudNote Backend Service
After=network.target mysql.service

[Service]
Type=simple
User=cloudnote
WorkingDirectory=/opt/cloudnote
ExecStart=/usr/bin/java -jar -Xms512m -Xmx1024m /opt/cloudnote/cloudnote-1.0.0.jar
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable cloudnote
sudo systemctl start cloudnote
sudo systemctl status cloudnote
```

### 6.2 JVM 参数优化
```bash
java -jar \
  -Xms512m \
  -Xmx1024m \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -Dfile.encoding=UTF-8 \
  cloudnote-1.0.0.jar
```

### 6.3 数据库优化
```sql
-- 添加索引优化查询
ALTER TABLE note ADD INDEX idx_user_deleted (user_id, deleted);
ALTER TABLE note ADD INDEX idx_created_at (created_at);
ALTER TABLE tag ADD INDEX idx_user_name (user_id, name);
```

### 6.4 文件上传目录权限
```bash
# 创建上传目录
sudo mkdir -p /var/cloudnote/uploads

# 设置权限
sudo chown -R cloudnote:cloudnote /var/cloudnote/uploads
sudo chmod 755 /var/cloudnote/uploads
```

## 7. 安全配置

### 7.1 修改 JWT 密钥
在 `application.yml` 中修改：
```yaml
jwt:
  secret: 你的随机密钥字符串（至少32位）
  expiration: 604800000  # 7天
```

### 7.2 配置 HTTPS（推荐）
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 其他配置同上...
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 7.3 数据库安全
```sql
-- 创建专用数据库用户
CREATE USER 'cloudnote'@'localhost' IDENTIFIED BY '强密码';
GRANT SELECT, INSERT, UPDATE, DELETE ON cloudnote.* TO 'cloudnote'@'localhost';
FLUSH PRIVILEGES;
```

## 8. 监控与维护

### 8.1 日志管理
```bash
# 查看后端日志
tail -f cloudnote.log

# 查看 Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 8.2 数据库备份
```bash
# 备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u root -p cloudnote > /backup/cloudnote_$DATE.sql
```

### 8.3 定期清理
```sql
-- 清理30天前的回收站笔记
DELETE FROM note 
WHERE deleted = 1 
AND deleted_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

## 9. 常见问题

### 9.1 后端启动失败
- 检查 MySQL 是否启动
- 检查数据库连接配置
- 检查端口 8080 是否被占用

### 9.2 前端无法访问后端
- 检查后端服务是否运行
- 检查防火墙设置
- 检查 Nginx 代理配置

### 9.3 文件上传失败
- 检查上传目录权限
- 检查文件大小限制配置
- 检查磁盘空间

### 9.4 图片无法显示
- 检查 Nginx 静态资源配置
- 检查文件路径是否正确
- 检查文件访问权限

## 10. 快速部署脚本

### 10.1 一键部署脚本（Linux）
```bash
#!/bin/bash

echo "开始部署 CloudNote..."

# 1. 编译后端
cd /path/to/cloudnote
mvn clean package -DskipTests

# 2. 停止旧服务
sudo systemctl stop cloudnote

# 3. 备份旧版本
cp /opt/cloudnote/cloudnote-1.0.0.jar /opt/cloudnote/backup/cloudnote-$(date +%Y%m%d).jar

# 4. 部署新版本
cp target/cloudnote-1.0.0.jar /opt/cloudnote/

# 5. 启动服务
sudo systemctl start cloudnote

# 6. 编译前端
cd front_end
npm install
npm run build

# 7. 部署前端
sudo rm -rf /var/www/cloudnote/dist/*
sudo cp -r dist/* /var/www/cloudnote/dist/

# 8. 重启 Nginx
sudo systemctl restart nginx

echo "部署完成！"
```

## 11. 联系支持
如遇到部署问题，请查看：
- 项目文档：README.md
- API 文档：API接口文档.md
- 系统设计：系统设计文档.md
