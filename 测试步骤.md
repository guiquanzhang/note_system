# 登录测试步骤

## 问题排查

如果登录提示密码错误，请按以下步骤排查：

### 步骤1：先注册一个新用户

**请求**:
```
POST http://localhost:8080/api/user/register
Content-Type: application/json

{
  "username": "testuser123",
  "password": "123456",
  "email": "test123@example.com"
}
```

**预期响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

### 步骤2：使用相同的用户名和密码登录

**请求**:
```
POST http://localhost:8080/api/user/login
Content-Type: application/json

{
  "username": "testuser123",
  "password": "123456"
}
```

**预期响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userId": 1,
    "username": "testuser123",
    "email": "test123@example.com"
  }
}
```

---

## 常见问题

### 问题1：使用了旧数据

**原因**: 数据库中有之前手动插入的用户，密码没有加密

**解决方案**: 
1. 删除旧用户数据
2. 通过注册接口重新创建用户

**SQL命令**:
```sql
-- 查看用户表
SELECT * FROM cloudnote.user;

-- 删除所有用户（谨慎操作）
DELETE FROM cloudnote.user;

-- 或者删除指定用户
DELETE FROM cloudnote.user WHERE username = 'testuser';
```

### 问题2：密码字段长度不够

**原因**: BCrypt 加密后的密码长度是60个字符，如果数据库字段太短会被截断

**检查方案**:
```sql
-- 查看user表结构
DESC cloudnote.user;

-- password字段应该是 VARCHAR(255)
-- 如果不是，执行以下命令修改
ALTER TABLE cloudnote.user MODIFY COLUMN password VARCHAR(255);
```

### 问题3：密码中有特殊字符

**原因**: JSON 中的特殊字符需要转义

**解决方案**: 使用简单密码测试，如 "123456"

---

## 完整测试流程（Postman）

### 1. 清空用户表（可选）
```sql
DELETE FROM cloudnote.user WHERE username = 'testuser123';
```

### 2. 注册新用户
```
POST http://localhost:8080/api/user/register

{
  "username": "testuser123",
  "password": "123456",
  "email": "test123@example.com"
}
```

### 3. 登录
```
POST http://localhost:8080/api/user/login

{
  "username": "testuser123",
  "password": "123456"
}
```

### 4. 使用Token访问受保护接口
```
GET http://localhost:8080/api/note/list?pageNum=1&pageSize=10
Authorization: Bearer {从登录接口获取的token}
```

---

## 调试技巧

### 1. 查看数据库中的密码是否加密
```sql
SELECT user_id, username, password, email FROM cloudnote.user;
```

加密后的密码应该类似：
```
$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
```

如果密码是明文（如 "123456"），说明注册时加密失败。

### 2. 检查应用日志

启动应用时添加调试日志：
```yaml
logging:
  level:
    com.cloudnote: debug
```

### 3. 添加调试代码（临时）

在 `UserServiceImpl.login()` 方法中添加日志：
```java
@Override
public LoginVO login(LoginDTO loginDTO) {
    // 查询用户
    User user = userMapper.selectOne(wrapper);
    
    System.out.println("输入的密码: " + loginDTO.getPassword());
    System.out.println("数据库密码: " + user.getPassword());
    System.out.println("密码验证结果: " + BCrypt.checkpw(loginDTO.getPassword(), user.getPassword()));
    
    // ... 其他代码
}
```

---

## 快速验证脚本（cURL）

### 注册
```bash
curl -X POST http://localhost:8080/api/user/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser123","password":"123456","email":"test123@example.com"}'
```

### 登录
```bash
curl -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser123","password":"123456"}'
```

---

## 如果问题依然存在

请提供以下信息：
1. 注册接口的响应
2. 登录接口的响应
3. 数据库中该用户的记录（SELECT * FROM user WHERE username='xxx'）
4. 应用启动日志中是否有错误信息
