# 后端实现指南

## 一、数据库更新

### 1. 执行SQL更新
```bash
# 连接到MySQL
mysql -u root -p

# 执行更新脚本
source 数据库更新语句.sql
```

### 2. 验证更新
```sql
-- 查看user表结构
DESC user;

-- 查看note表结构
DESC note;
```

## 二、实体类更新

### 1. User.java 添加字段

文件路径: `src/main/java/com/cloudnote/entity/User.java`

```java
@Data
@TableName("user")
public class User {
    @TableId(type = IdType.AUTO)
    private Integer userId;
    private String username;
    private String nickname;      // 新增
    private String password;
    private String email;
    private String avatar;        // 新增
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### 2. Note.java 添加字段

文件路径: `src/main/java/com/cloudnote/entity/Note.java`

```java
@Data
@TableName("note")
public class Note {
    @TableId(type = IdType.AUTO)
    private Integer noteId;
    private String title;
    private String content;
    private Integer userId;
    private Integer categoryId;
    private String tags;
    private Integer deleted;           // 新增
    private LocalDateTime deletedAt;   // 新增
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

## 三、DTO类创建

### 1. UpdateUserInfoDTO.java

文件路径: `src/main/java/com/cloudnote/dto/UpdateUserInfoDTO.java`

```java
package com.cloudnote.dto;

import lombok.Data;
import javax.validation.constraints.Email;
import javax.validation.constraints.Size;

@Data
public class UpdateUserInfoDTO {
    @Size(min = 3, max = 20, message = "用户名长度在3到20个字符")
    private String username;
    
    @Size(max = 50, message = "昵称长度不能超过50个字符")
    private String nickname;
    
    @Email(message = "邮箱格式不正确")
    private String email;
    
    private String avatar;
}
```

### 2. UpdatePasswordDTO.java

文件路径: `src/main/java/com/cloudnote/dto/UpdatePasswordDTO.java`

```java
package com.cloudnote.dto;

import lombok.Data;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.Size;

@Data
public class UpdatePasswordDTO {
    @NotBlank(message = "旧密码不能为空")
    private String oldPassword;
    
    @NotBlank(message = "新密码不能为空")
    @Size(min = 6, max = 20, message = "密码长度在6到20个字符")
    private String newPassword;
}
```

### 3. UserInfoVO.java

文件路径: `src/main/java/com/cloudnote/vo/UserInfoVO.java`

```java
package com.cloudnote.vo;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class UserInfoVO {
    private Integer userId;
    private String username;
    private String nickname;
    private String email;
    private String avatar;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

## 四、Service层实现

### UserService.java 添加方法

文件路径: `src/main/java/com/cloudnote/service/UserService.java`

```java
public interface UserService extends IService<User> {
    // 现有方法...
    
    /**
     * 获取用户信息
     */
    UserInfoVO getUserInfo();
    
    /**
     * 更新用户信息
     */
    void updateUserInfo(UpdateUserInfoDTO dto);
    
    /**
     * 修改密码
     */
    void updatePassword(UpdatePasswordDTO dto);
}
```

### UserServiceImpl.java 实现方法

文件路径: `src/main/java/com/cloudnote/service/impl/UserServiceImpl.java`

```java
@Override
public UserInfoVO getUserInfo() {
    Integer userId = UserContext.getUserId();
    User user = getById(userId);
    if (user == null) {
        throw new RuntimeException("用户不存在");
    }
    
    UserInfoVO vo = new UserInfoVO();
    BeanUtils.copyProperties(user, vo);
    return vo;
}

@Override
public void updateUserInfo(UpdateUserInfoDTO dto) {
    Integer userId = UserContext.getUserId();
    User user = getById(userId);
    if (user == null) {
        throw new RuntimeException("用户不存在");
    }
    
    // 检查用户名是否已存在
    if (dto.getUsername() != null && !dto.getUsername().equals(user.getUsername())) {
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(User::getUsername, dto.getUsername());
        if (count(wrapper) > 0) {
            throw new RuntimeException("用户名已存在");
        }
        user.setUsername(dto.getUsername());
    }
    
    if (dto.getNickname() != null) {
        user.setNickname(dto.getNickname());
    }
    if (dto.getEmail() != null) {
        user.setEmail(dto.getEmail());
    }
    if (dto.getAvatar() != null) {
        user.setAvatar(dto.getAvatar());
    }
    
    updateById(user);
}

@Override
public void updatePassword(UpdatePasswordDTO dto) {
    Integer userId = UserContext.getUserId();
    User user = getById(userId);
    if (user == null) {
        throw new RuntimeException("用户不存在");
    }
    
    // 验证旧密码
    if (!passwordEncoder.matches(dto.getOldPassword(), user.getPassword())) {
        throw new RuntimeException("旧密码错误");
    }
    
    // 更新密码
    user.setPassword(passwordEncoder.encode(dto.getNewPassword()));
    updateById(user);
}
```

## 五、Controller层实现

### UserController.java 添加接口

文件路径: `src/main/java/com/cloudnote/controller/UserController.java`

```java
/**
 * 获取用户信息
 */
@GetMapping("/info")
public Result<UserInfoVO> getUserInfo() {
    UserInfoVO userInfo = userService.getUserInfo();
    return Result.success(userInfo);
}

/**
 * 更新用户信息
 */
@PutMapping("/info")
public Result<Void> updateUserInfo(@RequestBody @Valid UpdateUserInfoDTO dto) {
    userService.updateUserInfo(dto);
    return Result.success();
}

/**
 * 修改密码
 */
@PutMapping("/password")
public Result<Void> updatePassword(@RequestBody @Valid UpdatePasswordDTO dto) {
    userService.updatePassword(dto);
    return Result.success();
}
```

## 六、NoteService 添加软删除支持

### NoteServiceImpl.java 修改查询方法

```java
@Override
public IPage<Note> getNoteList(Integer pageNum, Integer pageSize) {
    Integer userId = UserContext.getUserId();
    Page<Note> page = new Page<>(pageNum, pageSize);
    
    LambdaQueryWrapper<Note> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(Note::getUserId, userId)
           .eq(Note::getDeleted, 0)  // 只查询未删除的笔记
           .orderByDesc(Note::getUpdatedAt);
    
    return page(page, wrapper);
}

@Override
public void deleteNote(Integer noteId) {
    Integer userId = UserContext.getUserId();
    Note note = getById(noteId);
    
    if (note == null || !note.getUserId().equals(userId)) {
        throw new RuntimeException("笔记不存在或无权限");
    }
    
    // 软删除：标记为已删除
    note.setDeleted(1);
    note.setDeletedAt(LocalDateTime.now());
    updateById(note);
}
```

## 七、测试步骤

### 1. 重启后端服务
```bash
# 停止现有服务
# 重新启动 Spring Boot 应用
```

### 2. 测试用户信息接口

**获取用户信息**:
```bash
curl -X GET http://localhost:8080/api/user/info \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**更新用户信息**:
```bash
curl -X PUT http://localhost:8080/api/user/info \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nickname": "新昵称",
    "email": "new@example.com",
    "avatar": "data:image/png;base64,..."
  }'
```

**修改密码**:
```bash
curl -X PUT http://localhost:8080/api/user/password \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "oldPassword": "123456",
    "newPassword": "654321"
  }'
```

### 3. 测试软删除

**删除笔记**:
```bash
curl -X DELETE http://localhost:8080/api/note/1 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**验证笔记已软删除**:
```sql
SELECT * FROM note WHERE note_id = 1;
-- 应该看到 deleted = 1, deleted_at 有值
```

**验证列表不显示已删除笔记**:
```bash
curl -X GET http://localhost:8080/api/note/list \
  -H "Authorization: Bearer YOUR_TOKEN"
-- 已删除的笔记不应该出现在列表中
```

## 八、注意事项

1. **头像存储**
   - 当前使用Base64存储在数据库
   - 如果头像较大，建议改为文件上传到服务器或OSS
   - TEXT字段最大约64KB，足够存储小头像

2. **软删除**
   - 所有查询都要加 `deleted = 0` 条件
   - 定时任务清理超过30天的已删除笔记
   - 提供恢复功能前不要物理删除

3. **密码安全**
   - 修改密码后建议让用户重新登录
   - 可以考虑添加密码强度验证
   - 记录密码修改日志

4. **性能优化**
   - 头像字段较大，查询时可以不返回
   - 使用VO对象，按需返回字段
   - 添加缓存减少数据库查询

## 九、后续功能

### 回收站功能
需要添加以下接口：
- `GET /api/notes/trash` - 获取回收站列表
- `PUT /api/notes/{id}/restore` - 恢复笔记
- `DELETE /api/notes/{id}/permanent` - 彻底删除
- `DELETE /api/notes/trash/clear` - 清空回收站

### 批量操作
需要添加以下接口：
- `PUT /api/notes/batch-delete` - 批量删除
- `PUT /api/notes/batch-restore` - 批量恢复

详细实现见《功能优化规划.md》
